{
  "meta": {
    "project": "Bloodline Storybook (Phase 1)",
    "planType": "SPRINT_TASKS_JSON",
    "sprint": {
      "number": 5,
      "title": "Create Storybook Flow (Templates → Chapters → Editor v0) — Convex",
      "duration": "1 week",
      "goal": "Ship a usable v0 storybook creation experience on Convex: choose template/blank, generate chapters, edit chapter content (text + basic image placeholders), reorder chapters, and autosave with resilient UX.",
      "definitionOfDone": [
        "User can create a storybook from template or blank (Convex)",
        "Chapters list view with reorder + rename + add/delete",
        "Editor v0 supports rich text blocks + image placeholder blocks (no uploads yet)",
        "Autosave with optimistic UX + retry/backoff + conflict-safe v0",
        "All reads/writes protected by Convex AuthZ helpers",
        "Basic analytics events for creation funnel wired"
      ]
    },
    "stackAssumptions": {
      "frontend": "Next.js (App Router) + TypeScript",
      "db": "Convex",
      "ui": "Tailwind + shadcn/ui",
      "editor": "TipTap (recommended)",
      "state": "Convex React hooks (useQuery/useMutation) + local debounced state",
      "auth": "As implemented in Migration Sprint 3.5"
    }
  },
  "scope": {
    "inScope": [
      "Templates gallery and apply template (Convex mutation)",
      "Storybook dashboard (list + open + rename)",
      "Chapters management (add, rename, delete, reorder)",
      "Chapter editor v0 (text blocks + image placeholder blocks)",
      "Autosave and draft persistence using Convex mutations",
      "Empty states and onboarding guidance"
    ],
    "outOfScope": [
      "Actual media uploads (Cloudflare R2) — later sprint",
      "Stock media search providers (Unsplash/Pexels/Pixabay/Openverse/Rawpixel/Vecteezy) — later sprint",
      "Video/GIF blocks — later sprint with media rules",
      "PDF export — later sprint"
    ]
  },
  "backlog": [
    {
      "id": "S5C-T01",
      "title": "Templates gallery UX + apply template using Convex",
      "skill": ["Frontend (Next.js)", "Convex Functions", "Product UX"],
      "priority": "P0",
      "requirements": {
        "pages": ["/app/templates", "/app/start"],
        "templateCard": [
          "name",
          "short description",
          "chapter count",
          "preview chapters",
          "apply CTA"
        ],
        "applyBehavior": [
          "Call Convex mutation templates.apply({ templateId })",
          "Creates storybook + chapters with correct orderIndex",
          "Seeds each chapter with starter TEXT block (empty or prompt)"
        ],
        "constraints": [
          "Templates are versioned (templateId + templateVersion)",
          "Applying template copies into user-owned docs; no shared references"
        ]
      },
      "acceptanceTests": [
        "User can apply a template and lands in the created storybook",
        "Chapters appear in correct order and are editable",
        "Reload persists created storybook and chapters"
      ],
      "deliverables": [
        "app/app/templates/page.tsx",
        "components/templates/*",
        "convex/templates.ts (apply mutation) OR content/templates/* + convex/storybooks.createFromTemplate mutation"
      ]
    },
    {
      "id": "S5C-T02",
      "title": "Storybook dashboard v0 (list, create blank, open, rename) using Convex queries",
      "skill": ["Frontend (Next.js)", "Convex Client"],
      "priority": "P0",
      "requirements": {
        "pages": ["/app", "/app/storybooks/:id"],
        "features": [
          "List storybooks (recent first)",
          "Create blank storybook (default DIGITAL mode for now)",
          "Rename storybook title/subtitle",
          "Archive/Delete (optional)"
        ],
        "states": [
          "Empty state CTA to /app/start",
          "Loading skeletons",
          "Error state with retry"
        ],
        "data": [
          "useQuery(storybooks.listMine)",
          "useMutation(storybooks.create / update / archive)"
        ],
        "constraints": [
          "Ensure auth is required for all app routes",
          "No cross-user access (server checks enforced)"
        ]
      },
      "acceptanceTests": [
        "User sees only their storybooks",
        "Rename persists and reflects after reload",
        "Empty state correctly routes into start flow"
      ],
      "deliverables": [
        "app/app/page.tsx updated",
        "app/app/storybooks/[id]/page.tsx",
        "components/storybooks/* updated to Convex"
      ]
    },
    {
      "id": "S5C-T03",
      "title": "Chapters sidebar: add/rename/delete + reorder (drag & drop) persisted to Convex",
      "skill": ["Frontend", "UX", "Convex Mutations"],
      "priority": "P0",
      "requirements": {
        "features": [
          "Add chapter (append to end)",
          "Rename inline",
          "Delete chapter (optional undo toast)",
          "Reorder via drag-and-drop",
          "Keyboard alternative reorder (move up/down) for accessibility"
        ],
        "libraries": ["@dnd-kit/core (recommended)"],
        "mutations": [
          "chapters.create",
          "chapters.rename",
          "chapters.remove",
          "chapters.reorder({ storybookId, orderedChapterIds })"
        ],
        "constraints": [
          "Reorder should be optimistic with rollback on failure",
          "Do not lose unsaved editor state when switching chapters"
        ]
      },
      "acceptanceTests": [
        "Reorder persists after refresh",
        "Rename persists and updates in sidebar",
        "Keyboard reorder works (minimum: move up/down)"
      ],
      "deliverables": [
        "components/chapters/ChaptersSidebar.tsx",
        "convex/chapters.ts (ensure reorder mutation exists and efficient)"
      ]
    },
    {
      "id": "S5C-T04",
      "title": "Editor v0 foundation: rich text (TipTap/Slate) + block list UI",
      "skill": ["Frontend Editor", "TypeScript", "UX"],
      "priority": "P0",
      "requirements": {
        "editorCapabilities": [
          "Rich text: headings, bold/italic, lists, quote",
          "Placeholder prompts",
          "Block list container (render blocks ordered)",
          "Insert block menu: Text / Image placeholder"
        ],
        "storageFormat": [
          "TEXT block: store editor doc JSON in chapterBlocks.content",
          "IMAGE placeholder block: store { caption, placementPreset, sizePct }"
        ],
        "constraints": [
          "No actual uploads in Sprint 5",
          "Keep content structure compatible with later media rules sprint"
        ]
      },
      "acceptanceTests": [
        "Text edits persist after refresh (via autosave)",
        "User can insert an image placeholder block with caption + placement preset",
        "Blocks load in correct orderIndex"
      ],
      "deliverables": [
        "components/editor/EditorShell.tsx",
        "components/editor/BlockList.tsx",
        "components/editor/blocks/TextBlock.tsx",
        "components/editor/blocks/ImagePlaceholderBlock.tsx",
        "lib/editor/serialize.ts"
      ]
    },
    {
      "id": "S5C-T05",
      "title": "Autosave v0: debounced saves + optimistic UI + retry/backoff (Convex)",
      "skill": ["Frontend", "Resilience", "Convex Client"],
      "priority": "P0",
      "requirements": {
        "autosave": [
          "Debounce 800–1500ms after user stops typing",
          "Saving indicator: Saving… / Saved / Error",
          "Retry with exponential backoff for transient errors",
          "Coalesce updates (do not spam mutations)"
        ],
        "writeStrategy": [
          "Prefer block-level saves: updateBlock(blockId, patch)",
          "If block doesn't exist yet: insertBlock then update",
          "Use local dirty state to avoid unnecessary writes"
        ],
        "constraints": [
          "Must not block typing",
          "Must handle rapid chapter switching safely"
        ]
      },
      "acceptanceTests": [
        "Typing triggers at most ~1 mutation/sec per active block",
        "Transient failures show error and recover automatically",
        "User sees stable 'Saved' state after successful write"
      ],
      "deliverables": [
        "lib/editor/autosave.ts",
        "components/editor/SaveStatus.tsx",
        "convex/blocks.ts (ensure update mutation supports partial patch)"
      ]
    },
    {
      "id": "S5C-T06",
      "title": "Conflict-safe v0 editing: versioning + last-write detection",
      "skill": ["Architecture", "Convex", "Frontend"],
      "priority": "P1",
      "requirements": {
        "mechanism": [
          "Add `version` number to chapterBlocks (or use updatedAt checks)",
          "Mutation updateBlock validates expectedVersion (optional param)",
          "On mismatch: return a structured conflict error"
        ],
        "ui": [
          "Toast/banner: 'This chapter changed elsewhere' + actions (Reload / Overwrite)",
          "Basic overwrite path allowed for v0"
        ],
        "constraints": [
          "No realtime collaboration yet; this is to prevent accidental overwrites across tabs"
        ]
      },
      "acceptanceTests": [
        "Two tabs editing the same block triggers a conflict in the older tab",
        "User can reload and continue without data loss",
        "Conflict errors are understandable"
      ],
      "deliverables": [
        "convex/blocks.ts (version checks)",
        "components/editor/ConflictBanner.tsx",
        "docs/conflict_handling_v0.md"
      ]
    },
    {
      "id": "S5C-T07",
      "title": "Editor UX polish: empty states, shortcuts, mobile layout",
      "skill": ["UX", "Frontend"],
      "priority": "P1",
      "requirements": {
        "ux": [
          "Empty chapter state with starter prompt",
          "Keyboard shortcuts (Cmd/Ctrl+B/I; headings optional)",
          "Sticky chapter title input",
          "Responsive: sidebar collapses into drawer on mobile"
        ],
        "a11y": [
          "Focus management when switching chapters",
          "Aria labels on block actions"
        ]
      },
      "acceptanceTests": [
        "Mobile editing is usable without horizontal scroll",
        "Switching chapters preserves current draft and does not lose text",
        "Keyboard shortcuts work"
      ],
      "deliverables": [
        "components/editor/* updates",
        "docs/editor_shortcuts.md"
      ]
    },
    {
      "id": "S5C-T08",
      "title": "Creation funnel analytics (template → chapter → first save) updated for Convex flow",
      "skill": ["Analytics", "Product"],
      "priority": "P1",
      "requirements": {
        "events": [
          "storybook_create_start",
          "template_view",
          "template_apply",
          "storybook_created",
          "chapter_selected",
          "block_inserted",
          "chapter_first_save",
          "storybook_rename"
        ],
        "constraints": [
          "No PII in analytics payload",
          "Avoid duplicate firing due to rerenders"
        ]
      },
      "acceptanceTests": [
        "Events fire once per user action",
        "Template apply emits storybook_created",
        "First successful autosave emits chapter_first_save"
      ],
      "deliverables": [
        "lib/analytics/events_creation.ts updated",
        "instrumentation in templates/editor"
      ]
    },
    {
      "id": "S5C-T09",
      "title": "QA checklist + smoke tests (create → edit → refresh → reorder) on Convex",
      "skill": ["QA", "Testing"],
      "priority": "P0",
      "requirements": {
        "testFlows": [
          "Create storybook from template",
          "Rename storybook and a chapter",
          "Edit text, insert image placeholder, refresh page",
          "Reorder chapters, refresh page",
          "Open same chapter in two tabs to test conflict-safe v0 (if S5C-T06 implemented)"
        ],
        "tools": ["Manual checklist required", "Playwright optional"]
      },
      "acceptanceTests": [
        "All flows pass without data loss",
        "No console errors in production build",
        "Unauthorized access blocked"
      ],
      "deliverables": [
        "docs/qa_checklist_s5_convex.md",
        "tests/e2e/create_edit_refresh.spec.ts (optional)"
      ]
    },
    {
      "id": "S5C-T10",
      "title": "Release Sprint 5: deploy and verify editor v0 in production (Convex)",
      "skill": ["Release", "DevOps-lite", "Convex"],
      "priority": "P0",
      "requirements": {
        "releaseChecklist": [
          "Verify template apply creates Convex docs correctly",
          "Verify autosave status and persistence on refresh",
          "Verify chapter reorder persists",
          "Verify error handling on failed saves (simulate offline)",
          "Verify mobile layout"
        ]
      },
      "acceptanceTests": [
        "Users can create and edit storybooks reliably",
        "No data loss on refresh",
        "Checklist recorded"
      ],
      "deliverables": ["docs/release_checklist_s5_convex.md"]
    }
  ],
  "sprintPlanning": {
    "suggestedOrder": [
      "S5C-T01",
      "S5C-T02",
      "S5C-T03",
      "S5C-T04",
      "S5C-T05",
      "S5C-T07",
      "S5C-T06",
      "S5C-T08",
      "S5C-T09",
      "S5C-T10"
    ],
    "timeboxGuidance": {
      "P0_total_days": 5,
      "P1_total_days": 1.5,
      "buffer_days": 0.5
    },
    "notes": [
      "This sprint assumes Sprint 4 Convex schema + CRUD is complete.",
      "Keep Editor v0 intentionally limited to rich text + image placeholders; real uploads/stock providers come later and plug into the same block model.",
      "For autosave, block-level updates are best: they limit payload size and reduce conflicts."
    ]
  }
}
