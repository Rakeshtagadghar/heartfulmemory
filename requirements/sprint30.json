{
  "meta": {
    "project": "Bloodline Storybook / Storykeeper Studio",
    "planType": "SPRINT_TASKS_JSON",
    "sprint": {
      "number": 30,
      "title": "Studio Pages UX v1: Scrollable Document View + Single-Page Mode + Per-Page Controls",
      "duration": "1 week",
      "goal": "Make the Studio page area scrollable like Canva: support two viewing modes (single-page focus vs continuous document), and add per-page controls (move up/down, hide/show, lock/unlock, delete, add page) on every page.",
      "definitionOfDone": [
        "Canvas area supports two modes: Single Page Mode and Continuous Pages Mode and buttons to toggle is in footer",
        "If 'Pages' is active: single page is shown (focused) and scrolling moves to next/prev page (page snapping)",
        "If 'Pages' is not active: all pages render in one continuous scroll (page 1 then page 2 then page 3...)",
        "Each page shows a page header/tool strip with controls: Move Up, Move Down, Hide/Show, Lock/Unlock, Delete, Add Page",
        "Page controls work reliably and persist to backend doc model",
        "Hidden pages are excluded from export by default (configurable) and clearly indicated in UI",
        "Locked pages cannot be edited (selection/move/resize disabled) until unlocked",
        "Performance remains smooth for multi-page documents (virtualize if needed)",
        "No regressions to selection, text edit toolbar, image crop sidebar, or export renderer"
      ]
    },
    "stackAssumptions": {
      "frontend": "Next.js + TypeScript",
      "state": "Your existing editor state management (store) + persisted Studio doc JSON",
      "backend": "Convex (studioDocs save/load)",
      "editor": "Canvas-like editor already exists; this sprint changes page rendering/scroll/navigation"
    }
  },
  "backlog": [
    {
      "id": "S30-T01",
      "title": "Define page view modes + persistence (single vs continuous) + UI toggle behavior",
      "skill": ["Product", "Frontend", "State Management"],
      "priority": "P0",
      "requirements": {
        "modes": [
          {
            "id": "single_page",
            "description": "Only one page visible at once; scroll up/down navigates between pages"
          },
          {
            "id": "continuous",
            "description": "All pages visible stacked vertically; normal scroll through full document"
          }
        ],
        "ui": [
          "Top bar 'Pages' button toggles single_page mode (active state shown)",
          "If 'Pages' not active => continuous mode"
        ],
        "persistence": [
          "Store mode in localStorage (per user) or in studioDoc.preferences (optional)"
        ],
        "constraints": [
          "Mode switch must not lose selection; selection should map to the right page after toggle"
        ]
      },
      "acceptanceTests": [
        "Toggling Pages changes mode instantly",
        "Mode persists on refresh (if enabled)",
        "Selection remains valid after mode switch"
      ],
      "deliverables": [
        "packages/editor/pages/viewMode.ts",
        "components/studio/PagesToggle.tsx",
        "docs/page_view_modes.md"
      ]
    },
    {
      "id": "S30-T02",
      "title": "Implement Continuous Pages Mode rendering (stacked pages in one scroll)",
      "skill": ["Frontend", "Editor Engineering"],
      "priority": "P0",
      "requirements": {
        "rendering": [
          "Render page frames stacked vertically with consistent gap",
          "Show page label/header area at top of each page container",
          "Maintain correct coordinate systems per page"
        ],
        "behavior": [
          "Normal browser scroll moves through pages",
          "Clicking inside a page sets it as active page (for toolbars/selection context)"
        ],
        "performance": [
          "Virtualize pages if page count is large (P1)",
          "Avoid rerendering all pages on small selection changes"
        ],
        "constraints": [
          "Must work with zoom level and pan (if supported). If pan exists, restrict pan to horizontal only in continuous mode (optional), or disable pan and rely on scroll."
        ]
      },
      "acceptanceTests": [
        "All pages visible and scrollable",
        "Editing a text box on page 2 does not affect page 1 layout",
        "Active page context updates when clicking different pages"
      ],
      "deliverables": [
        "packages/editor/pages/ContinuousPagesView.tsx",
        "packages/editor/pages/pageLayout.css (or equivalent)"
      ]
    },
    {
      "id": "S30-T03",
      "title": "Implement Single Page Mode (scroll-to-navigate with snapping)",
      "skill": ["Frontend", "Editor Engineering"],
      "priority": "P0",
      "requirements": {
        "behavior": [
          "Only one page rendered (or one page fully visible) at a time",
          "Mouse wheel / trackpad scroll triggers next/prev page navigation",
          "Page snapping: after scroll, ensure the next page is fully in view",
          "Keyboard shortcuts (optional): PgUp/PgDn, ArrowUp/ArrowDown for page nav"
        ],
        "ui": [
          "Show current page index (e.g., 1/12) near Pages control",
          "Optional thumbnails button later; not required this sprint"
        ],
        "constraints": [
          "Avoid accidental rapid page flips (debounce/threshold)",
          "Do not break text editing scroll (when editing long text, scroll should still move caret inside text area). Use a rule: if focused in editable text area, do not intercept scroll."
        ]
      },
      "acceptanceTests": [
        "Scroll navigates pages predictably",
        "When typing in a text box, scroll doesn't unexpectedly flip pages",
        "Current page indicator updates"
      ],
      "deliverables": [
        "packages/editor/pages/SinglePageView.tsx",
        "packages/editor/pages/useScrollPageNavigation.ts",
        "docs/single_page_scroll_rules.md"
      ]
    },
    {
      "id": "S30-T04",
      "title": "Add per-page control strip UI (up/down, hide, lock, delete, add page)",
      "skill": ["Frontend", "UX"],
      "priority": "P0",
      "requirements": {
        "controlsPerPage": [
          "Move Up",
          "Move Down",
          "Hide/Show",
          "Lock/Unlock",
          "Delete",
          "Add Page"
        ],
        "placement": [
          "Top-right of each page container (like Canva page chrome)",
          "Visible on hover, always visible on active page"
        ],
        "constraints": [
          "Controls must be keyboard accessible",
          "Show confirm dialog for Delete"
        ]
      },
      "acceptanceTests": [
        "Controls appear for every page and match expected icon behavior",
        "Delete prompts confirmation",
        "Add Page creates a new page in correct location"
      ],
      "deliverables": [
        "packages/editor/pages/PageControls.tsx",
        "packages/editor/pages/PageHeaderChrome.tsx"
      ]
    },
    {
      "id": "S30-T05",
      "title": "Implement page operations in doc model (reorder, hide, lock, delete, insert)",
      "skill": ["Editor Engineering", "Backend", "State Management"],
      "priority": "P0",
      "requirements": {
        "docModelChanges": {
          "pageFields": [
            "id",
            "orderIndex",
            "isHidden (boolean)",
            "isLocked (boolean)",
            "title (optional)"
          ]
        },
        "operations": [
          "movePageUp(pageId)",
          "movePageDown(pageId)",
          "toggleHidden(pageId)",
          "toggleLocked(pageId)",
          "deletePage(pageId)",
          "insertPageAfter(pageId) or addPageAtEnd()"
        ],
        "constraints": [
          "Reordering must keep page IDs stable",
          "Deleting a page must update selection to nearest available page",
          "Hidden/locked state must persist to backend"
        ]
      },
      "acceptanceTests": [
        "All operations persist after refresh",
        "Moving page updates ordering in both modes",
        "Deleting a page does not crash and updates active page"
      ],
      "deliverables": [
        "packages/editor/model/pageOps.ts",
        "convex/studioDocs.ts updated (save/load new fields)",
        "docs/page_ops_contract.md"
      ]
    },
    {
      "id": "S30-T06",
      "title": "Lock behavior: prevent edits on locked pages (selection + transforms disabled)",
      "skill": ["Editor Engineering"],
      "priority": "P0",
      "requirements": {
        "lockedPageRules": [
          "Cannot select nodes on locked page (or selection allowed but transforms/text edit disabled—choose one; recommended: selection allowed, edits disabled with tooltip)",
          "No move/resize/rotate of nodes",
          "No text editing",
          "Allow unlock via page control strip"
        ],
        "constraints": [
          "Must not break global shortcuts",
          "Locked state should be visually obvious (subtle lock badge)"
        ]
      },
      "acceptanceTests": [
        "Editing is blocked on locked pages",
        "Unlock restores normal editing"
      ],
      "deliverables": [
        "packages/editor/guards/lockedPageGuard.ts",
        "packages/editor/ui/LockedBadge.tsx"
      ]
    },
    {
      "id": "S30-T07",
      "title": "Hide behavior: hidden pages UI + export policy",
      "skill": ["Frontend", "Rendering"],
      "priority": "P0",
      "requirements": {
        "ui": [
          "Hidden pages show a faint overlay + 'Hidden' label",
          "Optional: hide completely from continuous view if 'Hide' means remove from view (choose):",
          "A) hidden pages collapsed (not shown) but available in pages list (future)",
          "B) hidden pages still shown but visually muted (simpler v1)"
        ],
        "exportPolicy": [
          "Default: hidden pages are excluded from PDF export",
          "Provide a config flag: EXPORT_INCLUDE_HIDDEN_PAGES=false"
        ],
        "constraints": [
          "No breaking changes to renderer; filter pages before render"
        ]
      },
      "acceptanceTests": [
        "Hidden pages are visually indicated",
        "Hidden pages are not exported by default"
      ],
      "deliverables": [
        "packages/pdf/renderers/filterPages.ts updated",
        "docs/hidden_pages_export_policy.md"
      ]
    },
    {
      "id": "S30-T08",
      "title": "Scroll + selection correctness across modes (active page, focus, toolbar context)",
      "skill": ["Frontend", "Editor Engineering"],
      "priority": "P0",
      "requirements": {
        "rules": [
          "Active page updates when user clicks inside any page",
          "Toolbars reflect active page selection context",
          "In single-page mode, switching pages clears selection (or maps selection if same node exists—prefer clear selection)",
          "In continuous mode, selection remains as long as the page remains mounted"
        ],
        "constraints": [
          "Avoid selection bugs when pages are virtualized (if you implement virtualization)"
        ]
      },
      "acceptanceTests": [
        "No selection jumping between pages",
        "Toolbars operate on the correct page"
      ],
      "deliverables": [
        "packages/editor/pages/activePageStore.ts",
        "packages/editor/pages/selectionModeRules.ts"
      ]
    },
    {
      "id": "S30-T09",
      "title": "Performance pass (optional virtualization) for continuous mode",
      "skill": ["Performance", "Frontend"],
      "priority": "P1",
      "requirements": {
        "whenToVirtualize": [
          "If pages > N (e.g., 10), virtualize rendering",
          "Keep near-viewport pages mounted for smooth scroll"
        ],
        "constraints": [
          "Virtualization must preserve editing (only virtualize pages not being edited)",
          "Do not virtualize the active page"
        ]
      },
      "acceptanceTests": [
        "Scrolling remains smooth with 20+ pages",
        "Editing does not break when virtualization is active"
      ],
      "deliverables": [
        "packages/editor/pages/virtualization.ts",
        "docs/pages_virtualization.md"
      ]
    },
    {
      "id": "S30-T10",
      "title": "QA + automated tests for page modes and page operations",
      "skill": ["QA", "Testing"],
      "priority": "P0",
      "requirements": {
        "manualChecklist": [
          "Toggle Pages on -> single-page mode works; scroll flips pages",
          "Toggle Pages off -> continuous mode shows all pages stacked",
          "Move up/down reorders pages and persists after refresh",
          "Lock page blocks edits; unlock restores",
          "Hide page changes UI and excludes from export",
          "Delete page removes it safely and updates active page",
          "Add page creates new page in correct order"
        ],
        "automation": [
          "Unit: pageOps reorder/move/delete/insert",
          "Unit: derive visible pages respects isHidden and export policy",
          "UI test: mode toggle switches between SinglePageView and ContinuousPagesView"
        ]
      },
      "acceptanceTests": [
        "At least 4 automated tests added and passing",
        "No regressions in Studio core editing"
      ],
      "deliverables": [
        "tests/pages/pageOps.test.ts",
        "tests/pages/hiddenExportPolicy.test.ts",
        "tests/ui/pagesModeToggle.test.tsx",
        "docs/qa_sprint30_pages_scroll_modes.md"
      ]
    }
  ],
  "sprintPlanning": {
    "suggestedOrder": [
      "S30-T01",
      "S30-T02",
      "S30-T03",
      "S30-T04",
      "S30-T05",
      "S30-T06",
      "S30-T07",
      "S30-T08",
      "S30-T10",
      "S30-T09"
    ],
    "timeboxGuidance": {
      "P0_total_days": 5,
      "P1_total_days": 1,
      "buffer_days": 1
    },
    "notes": [
      "This sprint implements the Canva-like page browsing behavior shown in your screenshots: continuous scroll when Pages is not active, and scroll-to-navigate when Pages is active.",
      "The biggest UX risk is intercepting scroll while editing text; implement clear rules so text editing scroll doesn't flip pages."
    ]
  }
}
