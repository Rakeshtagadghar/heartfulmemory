{
  "meta": {
    "project": "Bloodline Storybook / Storykeeper",
    "planType": "SPRINT_TASKS_JSON",
    "sprint": {
      "number": 24,
      "title": "Observability v1: Sentry (Errors + Performance + Release Tracking)",
      "duration": "1 week",
      "goal": "Add production-grade observability using Sentry across the app (Next.js client + server) with actionable context for Studio, AI generation, and export flows. Ship alerts + release tracking so you can debug real user issues quickly.",
      "definitionOfDone": [
        "Sentry captures client + server errors in production with readable stack traces (sourcemaps)",
        "Performance tracing is enabled for key flows (Studio load, populate, export, AI draft generation, STT)",
        "Events include high-signal tags/contexts (storybookId, chapterKey, mode, user plan) without leaking PII",
        "Release + environment tags are attached (prod/staging/dev) and correlate to deployments",
        "Alerts are configured for error spikes and export failures",
        "A standard error-handling pattern exists (user-safe messages + Sentry correlation id)",
        "Regression tests / smoke test confirms Sentry receives events in each runtime"
      ]
    },
    "stackAssumptions": {
      "frontend": "Next.js (App Router) + TypeScript",
      "backend": "Convex + Next.js route handlers/actions",
      "observability": "Sentry (Next.js SDK)",
      "deployment": "Vercel (or similar) with build-time env vars",
      "privacy": "No transcripts/photos/raw story content sent to Sentry; only metadata/tags"
    }
  },
  "backlog": [
    {
      "id": "S24-T01",
      "title": "Define observability policy (what we capture vs redact) + tagging conventions",
      "skill": ["Architecture", "Security/Privacy", "DX"],
      "priority": "P0",
      "requirements": {
        "policy": {
          "neverSend": [
            "full chapter transcript text",
            "full story narrative text",
            "image URLs containing user-private keys",
            "payment details",
            "access tokens",
            "email content"
          ],
          "allowedMetadata": [
            "storybookId (internal id)",
            "chapterKey",
            "route/pathname",
            "feature flags state (boolean)",
            "export mode (digital|hardcopy)",
            "provider (stt/llm/photos)",
            "performance timings",
            "error codes (stable enums)"
          ],
          "redactionRules": [
            "mask query params except whitelisted keys",
            "sanitize error messages to remove user content",
            "strip request bodies from server errors by default"
          ]
        },
        "tagging": {
          "tags": ["env", "release", "feature", "flow", "provider", "mode"],
          "contexts": ["storybook", "chapter", "billingEntitlement"],
          "breadcrumbs": [
            "ui_action",
            "api_call",
            "editor_action",
            "export_step"
          ]
        },
        "constraints": [
          "All errors must be traceable to a user action and flow without storing PII"
        ]
      },
      "acceptanceTests": [
        "Policy doc exists and is referenced in code comments for Sentry init and capture helpers",
        "A centralized helper enforces redaction and tagging"
      ],
      "deliverables": [
        "docs/observability_policy.md",
        "lib/observability/sentryContext.ts"
      ]
    },
    {
      "id": "S24-T02",
      "title": "Install and initialize Sentry for Next.js (client + server) with environments",
      "skill": ["Frontend", "Platform"],
      "priority": "P0",
      "requirements": {
        "init": [
          "Client runtime init (browser)",
          "Server runtime init (Next.js server)",
          "Optional: Edge runtime init if used"
        ],
        "env": [
          "SENTRY_DSN",
          "SENTRY_ENVIRONMENT (dev/staging/prod)",
          "SENTRY_RELEASE (commit sha or build id)"
        ],
        "defaults": [
          "sampleRate tuned (lower in prod if needed)",
          "disable in local dev unless explicitly enabled"
        ],
        "constraints": [
          "No runtime errors if DSN is missing in dev",
          "Separate envs for staging vs prod"
        ]
      },
      "acceptanceTests": [
        "Client-side exception is captured in staging/prod",
        "Server-side exception is captured in staging/prod"
      ],
      "deliverables": [
        "sentry.client.config.ts (or equivalent)",
        "sentry.server.config.ts (or equivalent)",
        "lib/observability/sentryInit.ts"
      ]
    },
    {
      "id": "S24-T03",
      "title": "Sourcemaps + release tracking integration (readable stack traces)",
      "skill": ["Platform", "DevOps-lite"],
      "priority": "P0",
      "requirements": {
        "release": [
          "Set SENTRY_RELEASE to git SHA / build id",
          "Upload sourcemaps during CI/build (Sentry CLI or Next plugin)",
          "Mark deploy environment in Sentry"
        ],
        "constraints": [
          "Do not expose sourcemaps publicly if avoidable",
          "Ensure build pipeline works for preview + production"
        ]
      },
      "acceptanceTests": [
        "A minified production error shows readable stack frames in Sentry",
        "Events are grouped by release and environment"
      ],
      "deliverables": [
        "build/ci config updates (vercel/gh actions)",
        "docs/sentry_release_sourcemaps.md"
      ]
    },
    {
      "id": "S24-T04",
      "title": "Create standard capture helpers (captureException + captureMessage) with redaction + tags",
      "skill": ["Backend", "Frontend", "DX"],
      "priority": "P0",
      "requirements": {
        "helpers": [
          "captureAppError(error, { flow, code, storybookId?, chapterKey?, mode?, provider? })",
          "captureAppWarning(message, context)",
          "withSentrySpan(name, context, fn)"
        ],
        "redaction": [
          "Strip/replace raw text fields",
          "Clamp string lengths",
          "Whitelist safe context keys only"
        ],
        "constraints": [
          "Helpers must be usable from both client and server code"
        ]
      },
      "acceptanceTests": [
        "All captured errors include consistent tags/contexts",
        "No PII appears in captured payloads from common flows"
      ],
      "deliverables": [
        "lib/observability/capture.ts",
        "lib/observability/redact.ts",
        "lib/observability/spans.ts"
      ]
    },
    {
      "id": "S24-T05",
      "title": "Instrument Studio critical flows (breadcrumbs + spans)",
      "skill": ["Frontend", "Editor Engineering"],
      "priority": "P0",
      "requirements": {
        "flowsToInstrument": [
          "Studio open (load doc)",
          "Chapter populate (start/success/fail)",
          "Insert media (uploads/photos)",
          "Crop mode enter/apply",
          "Selection/layer operations (high level only)",
          "Export click (gated or allowed)"
        ],
        "breadcrumbs": [
          "action name + node type + pageId (no raw text)",
          "timings for heavy actions"
        ],
        "constraints": [
          "Do not spam Sentry with high-frequency editor events; throttle or sample",
          "Only instrument key 'milestones' not every mouse move"
        ]
      },
      "acceptanceTests": [
        "A Studio failure includes breadcrumbs that identify the last 10 key actions",
        "Performance traces show Studio load and populate timings"
      ],
      "deliverables": [
        "apps/web/components/studio/observability.ts",
        "packages/editor/observability/editorBreadcrumbs.ts"
      ]
    },
    {
      "id": "S24-T06",
      "title": "Instrument backend/Convex actions (AI draft, STT, auto-illustrate, export) with spans + error codes",
      "skill": ["Convex", "Backend"],
      "priority": "P0",
      "requirements": {
        "targets": [
          "chapterDrafts.generateV2 / regenSectionV2",
          "entities.extractFromAnswers",
          "chapterIllustrations.autoIllustrateV2",
          "studio.populateChapter",
          "export.run (if present)",
          "stt.transcribe"
        ],
        "spanFields": ["provider", "durationMs", "attempt", "errorCode"],
        "constraints": [
          "Never attach raw prompt/transcript/story text to Sentry events",
          "Prefer stable error codes over raw provider messages"
        ]
      },
      "acceptanceTests": [
        "A failing provider call captures a Sentry event with code + provider + chapterKey",
        "Traces show which step is slow (fetch candidates vs cache vs render)"
      ],
      "deliverables": [
        "convex/observability/sentry.ts",
        "lib/errors/errorCodes.ts (stable enums)"
      ]
    },
    {
      "id": "S24-T07",
      "title": "User-safe error surfaces + correlation id (support-friendly)",
      "skill": ["Frontend", "UX", "DX"],
      "priority": "P1",
      "requirements": {
        "ui": [
          "Standard toast/banner for recoverable errors",
          "Friendly failure pages for hard errors (retry + back)",
          "Optional: show 'Error reference' (short id) for support"
        ],
        "logic": [
          "Map internal error codes to user messages",
          "Attach correlation id to Sentry context and UI error state"
        ],
        "constraints": [
          "Never show raw stack traces to users",
          "Keep elder-friendly copy"
        ]
      },
      "acceptanceTests": [
        "Users see helpful, non-technical error messages",
        "Support can find matching issue using reference id"
      ],
      "deliverables": [
        "lib/errors/userMessages.ts",
        "components/ui/ErrorBanner.tsx",
        "docs/error_reference_support.md"
      ]
    },
    {
      "id": "S24-T08",
      "title": "Alerts & dashboards setup for key failure modes (export + AI + Studio)",
      "skill": ["Ops", "DX"],
      "priority": "P1",
      "requirements": {
        "alerts": [
          "New issue spike alert (prod)",
          "Export failures threshold alert",
          "AI generation failures threshold alert",
          "Performance: Studio load p95 regression alert (optional)"
        ],
        "dashboards": [
          "Top issues in last 24h",
          "Top slow transactions/spans",
          "Export success rate"
        ],
        "constraints": ["Keep noise low; start with a few high-signal alerts"]
      },
      "acceptanceTests": [
        "Alerts exist and can be tested in staging",
        "Dashboard shows meaningful metrics"
      ],
      "deliverables": [
        "docs/sentry_alerts_setup.md",
        "docs/sentry_dashboard.md"
      ]
    },
    {
      "id": "S24-T09",
      "title": "QA + smoke tests (client/server capture + perf traces + redaction verification)",
      "skill": ["QA", "Testing"],
      "priority": "P0",
      "requirements": {
        "manualChecklist": [
          "Trigger client error in Studio and verify it appears in Sentry with tags",
          "Trigger server error in an API route/Convex action and verify it appears",
          "Verify stack traces are symbolicated (sourcemaps)",
          "Verify no raw transcript/story text appears in event payload",
          "Check performance trace for Studio open + populate",
          "Check alerts can trigger in staging"
        ],
        "automation": [
          "Unit test: redact() removes known sensitive keys",
          "Integration: capture helper attaches tags correctly"
        ]
      },
      "acceptanceTests": [
        "Sentry captures events from both client and server with correct releases",
        "Redaction test suite passes"
      ],
      "deliverables": [
        "tests/observability/redact.test.ts",
        "tests/observability/capture.test.ts",
        "docs/qa_sprint24_sentry.md"
      ]
    }
  ],
  "sprintPlanning": {
    "suggestedOrder": [
      "S24-T01",
      "S24-T02",
      "S24-T03",
      "S24-T04",
      "S24-T06",
      "S24-T05",
      "S24-T07",
      "S24-T08",
      "S24-T09"
    ],
    "timeboxGuidance": {
      "P0_total_days": 4.5,
      "P1_total_days": 1.5,
      "buffer_days": 1
    },
    "notes": [
      "Instrument key milestones only (avoid high-frequency editor events).",
      "Make privacy/redaction non-negotiable: never send transcript/story content to Sentry.",
      "Release + sourcemaps are what turn Sentry from 'noise' into 'actionable'."
    ]
  }
}
