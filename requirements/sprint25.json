{
  "meta": {
    "project": "Bloodline Storybook / Storykeeper",
    "planType": "SPRINT_TASKS_JSON",
    "sprint": {
      "number": 25,
      "title": "Monetization v1: Stripe Billing + Crown Export Paywall (Upgrade Flow)",
      "duration": "1 week",
      "goal": "Integrate Stripe Billing for subscriptions and gate premium actions (Export) in Studio with a crown button and Upgrade flow. Persist entitlements in Convex via webhooks, support customer self-serve via Stripe Customer Portal, and provide a clean upgrade UX at the moment of intent.",
      "definitionOfDone": [
        "Stripe products/prices are configured for Free vs Pro (and optionally Team placeholder)",
        "Users can upgrade via Stripe Checkout and become 'Pro' based on webhook-confirmed subscription status",
        "Studio shows Export as a crown button for Free users and triggers Upgrade modal instead of export",
        "Paid users can export as normal (button triggers export pipeline)",
        "Stripe webhooks update entitlements in Convex reliably (idempotent, verified signature)",
        "Users can manage billing (cancel/update card) via Stripe Customer Portal",
        "All paywall/upgrade actions are tracked with events (internal analytics hooks; PostHog not required)",
        "No sensitive data leaks to client; all Stripe secrets remain server-side"
      ]
    },
    "stackAssumptions": {
      "frontend": "Next.js (App Router) + TypeScript",
      "backend": "Convex for app data + Next.js route handlers for Stripe API + webhook endpoint",
      "payments": "Stripe Billing + Stripe Checkout + Customer Portal",
      "auth": "Existing auth system provides stable userId/email; map to Stripe customer",
      "observability": "Sentry already added in Sprint 24"
    }
  },
  "backlog": [
    {
      "id": "S25-T01",
      "title": "Define pricing + entitlements model (what Free vs Pro can do)",
      "skill": ["Product", "Architecture"],
      "priority": "P0",
      "requirements": {
        "plans": [
          {
            "id": "free",
            "features": [
              "Create storybooks",
              "Generate drafts (basic)",
              "Studio edit",
              "Preview export (optional watermarked)"
            ],
            "limits": {
              "exportsPerMonth": 0,
              "hardcopyExport": false
            }
          },
          {
            "id": "pro",
            "features": [
              "Digital export (PDF)",
              "Hardcopy export mode (optional feature flag)",
              "Higher limits (chapters/assets)",
              "Priority generation (later)"
            ],
            "limits": {
              "exportsPerMonth": 50,
              "hardcopyExport": true
            }
          }
        ],
        "entitlements": [
          "canExportDigital",
          "canExportHardcopy",
          "exportsRemaining (nullable if unlimited)",
          "planId",
          "subscriptionStatus"
        ],
        "constraints": [
          "Entitlements must be derived from Stripe subscription status (webhook-confirmed)",
          "Keep entitlements cacheable in Convex for fast gating checks"
        ]
      },
      "acceptanceTests": [
        "A single entitlement object can answer: can user export? which modes? what limits remain?",
        "Plan changes map cleanly to entitlements without code rewrites"
      ],
      "deliverables": [
        "docs/pricing_entitlements_v1.md",
        "packages/shared/billing/entitlements.ts"
      ]
    },
    {
      "id": "S25-T02",
      "title": "Create Stripe products/prices in Stripe Dashboard (Pro monthly/annual)",
      "skill": ["Ops", "Payments"],
      "priority": "P0",
      "requirements": {
        "stripeConfig": [
          "Product: Memorioso Pro",
          "Price: Pro Monthly (recurring)",
          "Price: Pro Annual (recurring, optional)",
          "Optional: Trial days (decide now)"
        ],
        "metadata": ["planId=pro", "app=memorioso"],
        "constraints": [
          "Store priceIds in environment variables",
          "Do not hardcode secrets in repo"
        ]
      },
      "acceptanceTests": [
        "Price IDs exist and are usable by Checkout Session creation",
        "Metadata is present on subscription for webhook mapping"
      ],
      "deliverables": [
        "docs/stripe_products_prices.md",
        "env.example updated with STRIPE_PRICE_ID_PRO_MONTHLY/ANNUAL"
      ]
    },
    {
      "id": "S25-T03",
      "title": "Convex billing tables: link app user -> Stripe customer + subscription state",
      "skill": ["Convex", "Data Modeling"],
      "priority": "P0",
      "requirements": {
        "tables": [
          {
            "name": "billingCustomers",
            "fields": [
              "id (Convex _id)",
              "userId (string)",
              "email (string|null)",
              "stripeCustomerId (string)",
              "createdAt (number)",
              "updatedAt (number)"
            ],
            "indexes": ["by_userId", "by_stripeCustomerId"]
          },
          {
            "name": "billingSubscriptions",
            "fields": [
              "id (Convex _id)",
              "userId (string)",
              "stripeCustomerId (string)",
              "stripeSubscriptionId (string)",
              "planId (string)",
              "status (string: trialing|active|past_due|canceled|unpaid|incomplete)",
              "currentPeriodEnd (number|null)",
              "cancelAtPeriodEnd (boolean)",
              "latestInvoiceId (string|null)",
              "updatedAt (number)"
            ],
            "indexes": [
              "by_userId",
              "by_stripeSubscriptionId",
              "by_stripeCustomerId"
            ]
          }
        ],
        "constraints": [
          "Only user can read their billing state (or admin)",
          "Subscription updates come from webhooks only (source of truth)"
        ]
      },
      "acceptanceTests": [
        "Schema compiles; can read billing state for current user",
        "Webhook updates can upsert subscription records idempotently"
      ],
      "deliverables": [
        "convex/schema.ts updated",
        "convex/billing.ts (queries/mutations)"
      ]
    },
    {
      "id": "S25-T04",
      "title": "Server endpoint: create Stripe Checkout Session for subscription upgrade",
      "skill": ["Backend (Next.js)", "Stripe API"],
      "priority": "P0",
      "requirements": {
        "endpoint": "POST /api/billing/checkout",
        "inputs": ["priceId", "successUrl", "cancelUrl"],
        "behavior": [
          "Authenticate user",
          "Find or create Stripe customer for user",
          "Create Checkout Session (mode=subscription) for selected price",
          "Return sessionUrl to client"
        ],
        "constraints": [
          "Stripe secret key server-only",
          "Do not trust client planId; validate allowed priceIds",
          "Attach metadata: userId, planId"
        ],
        "notes": [
          "Checkout Sessions creation is documented in Stripe API reference."
        ]
      },
      "acceptanceTests": [
        "Free user can open Stripe Checkout session URL",
        "Existing customer re-used (no duplicates) when upgrading again"
      ],
      "deliverables": [
        "app/api/billing/checkout/route.ts",
        "lib/stripe/stripeClient.ts",
        "lib/stripe/priceAllowlist.ts"
      ]
    },
    {
      "id": "S25-T05",
      "title": "Webhook endpoint: handle subscription lifecycle events and update Convex entitlements",
      "skill": ["Backend (Next.js)", "Stripe Webhooks", "Convex"],
      "priority": "P0",
      "requirements": {
        "endpoint": "POST /api/stripe/webhook",
        "webhookHandling": [
          "Verify signature using STRIPE_WEBHOOK_SECRET",
          "Handle key events for subscriptions and payments"
        ],
        "eventsToHandle": [
          "checkout.session.completed (subscription started)",
          "customer.subscription.updated",
          "customer.subscription.deleted",
          "invoice.payment_succeeded",
          "invoice.payment_failed"
        ],
        "idempotency": [
          "Store processed event IDs (in Convex or in-memory durable store) to prevent double-processing"
        ],
        "constraints": [
          "Do not rely only on checkout.session.completed; subscription status changes must be processed via subscription/invoice events",
          "Store only minimal billing metadata in Convex"
        ],
        "sources": ["Stripe docs: subscriptions webhooks and events."]
      },
      "acceptanceTests": [
        "Webhook updates subscription status in Convex when status changes (active/past_due/canceled)",
        "Duplicate webhook delivery does not create duplicate rows or flip-flop state",
        "When invoice.payment_failed occurs, user entitlements are downgraded per policy"
      ],
      "deliverables": [
        "app/api/stripe/webhook/route.ts",
        "convex/billing.ts updated (upsert from webhook)",
        "docs/stripe_webhooks_events.md"
      ]
    },
    {
      "id": "S25-T06",
      "title": "Entitlement resolver: map Stripe subscription state -> app permissions (export gating)",
      "skill": ["Backend", "Architecture"],
      "priority": "P0",
      "requirements": {
        "rules": [
          "status=active or trialing => plan entitlements enabled",
          "status=past_due => optional grace period (config-driven) else disable exports",
          "status=canceled/unpaid/incomplete => disable premium entitlements"
        ],
        "implementation": [
          "Convex query: billing.getEntitlementsForUser",
          "Client hook: useEntitlements() for gating UI",
          "Server guard: enforce on export actions too (never client-only)"
        ],
        "constraints": [
          "Never trust client gating alone",
          "Export endpoints/actions must check entitlements"
        ]
      },
      "acceptanceTests": [
        "Free users cannot trigger paid exports even via direct API calls",
        "Paid users can export",
        "Entitlements update within seconds after webhook receipt"
      ],
      "deliverables": [
        "convex/billing.ts (getEntitlements query)",
        "lib/billing/guards.ts",
        "packages/shared/billing/entitlementRules.ts"
      ]
    },
    {
      "id": "S25-T07",
      "title": "Studio UI: Export crown button + Upgrade modal/paywall (moment-of-intent gating)",
      "skill": ["Frontend", "UX"],
      "priority": "P0",
      "requirements": {
        "ui": [
          "Export button visible to all users",
          "If Free: show crown icon + label 'Upgrade to Export'",
          "If Pro: show normal 'Export' CTA"
        ],
        "paywallModal": [
          "Plan summary (Pro benefits: export, hardcopy mode, more limits)",
          "Price toggle monthly/annual",
          "Upgrade button -> opens Stripe Checkout session",
          "Secondary: 'Not now' close"
        ],
        "constraints": [
          "Do not block editing; paywall is only on export click",
          "Elder-friendly: simple copy, big CTA"
        ]
      },
      "acceptanceTests": [
        "Free user clicking Export opens upgrade modal (not export)",
        "Paid user clicking Export opens export flow",
        "Upgrade modal successfully redirects to Stripe Checkout"
      ],
      "deliverables": [
        "apps/web/components/studio/ExportButtonCrown.tsx",
        "apps/web/components/billing/UpgradeModal.tsx",
        "lib/billing/startCheckout.ts"
      ]
    },
    {
      "id": "S25-T08",
      "title": "Billing management: Stripe Customer Portal session + 'Manage billing' button",
      "skill": ["Backend (Next.js)", "Frontend", "Stripe API"],
      "priority": "P0",
      "requirements": {
        "endpoint": "POST /api/billing/portal",
        "behavior": [
          "Authenticate user",
          "Fetch stripeCustomerId for user",
          "Create billing portal session and return portalUrl"
        ],
        "ui": ["Account/Billing page with 'Manage billing' button"],
        "constraints": [
          "Portal sessions are short-lived; create on demand",
          "Only authenticated users can create portal sessions"
        ],
        "sources": [
          "Stripe API: create customer portal session and customer portal guide."
        ]
      },
      "acceptanceTests": [
        "User can open Stripe portal and manage subscription",
        "Portal cannot be created for another user's customerId"
      ],
      "deliverables": [
        "app/api/billing/portal/route.ts",
        "app/account/billing/page.tsx",
        "components/billing/ManageBillingButton.tsx"
      ]
    },
    {
      "id": "S25-T09",
      "title": "Upgrade success/cancel flows + UI refresh after Checkout",
      "skill": ["Frontend", "Integration"],
      "priority": "P1",
      "requirements": {
        "routes": ["/billing/success", "/billing/cancel"],
        "behavior": [
          "On success: show confirmation + 'Return to Studio' CTA",
          "Trigger entitlements refresh (Convex query invalidation)",
          "If webhook delay: show 'Activating your plan…' state with retry"
        ],
        "constraints": [
          "Do not mark user Pro on client; wait for webhook-confirmed status"
        ]
      },
      "acceptanceTests": [
        "After successful payment, user becomes Pro once webhook processed and UI updates",
        "Cancel returns user safely without changing entitlements"
      ],
      "deliverables": [
        "app/billing/success/page.tsx",
        "app/billing/cancel/page.tsx",
        "lib/billing/useEntitlements.ts updated"
      ]
    },
    {
      "id": "S25-T10",
      "title": "Event instrumentation for paywall + upgrade conversion (no PostHog)",
      "skill": ["Analytics", "Frontend"],
      "priority": "P1",
      "requirements": {
        "events": [
          "paywall_shown (source=studio_export)",
          "paywall_upgrade_click (planId)",
          "checkout_redirected",
          "billing_webhook_subscription_active",
          "billing_webhook_payment_failed",
          "export_click_blocked",
          "export_click_allowed"
        ],
        "constraints": [
          "No PII in events",
          "Store to your existing analytics sink/logs; can migrate to PostHog later"
        ]
      },
      "acceptanceTests": [
        "Events fire once per action and include source and planId",
        "Webhook events are logged with stable codes (not raw Stripe payload)"
      ],
      "deliverables": [
        "lib/analytics/billingEvents.ts",
        "lib/analytics/studioExportEvents.ts"
      ]
    },
    {
      "id": "S25-T11",
      "title": "QA + automated tests (webhook idempotency, entitlement gating, UI paywall)",
      "skill": ["QA", "Testing"],
      "priority": "P0",
      "requirements": {
        "manualChecklist": [
          "Free user clicks Export -> paywall opens",
          "Upgrade -> Stripe Checkout -> success -> entitlement becomes Pro (webhook-confirmed)",
          "Pro user clicks Export -> export flow opens",
          "Cancel subscription in portal -> entitlements downgrade",
          "Simulate invoice.payment_failed -> entitlements disabled per policy",
          "Double webhook delivery does not duplicate records"
        ],
        "automation": [
          "Unit: entitlementRules mapping statuses to permissions",
          "Integration: webhook handler verifies signature and upserts subscription idempotently (mock Stripe)",
          "UI test: Export crown triggers Upgrade modal for free user"
        ]
      },
      "acceptanceTests": [
        "At least 4 automated tests added and passing",
        "Export cannot be accessed by free users via direct calls"
      ],
      "deliverables": [
        "tests/billing/entitlements.test.ts",
        "tests/billing/webhook_idempotency.test.ts",
        "tests/ui/exportPaywall.test.tsx",
        "docs/qa_sprint25_stripe_billing.md"
      ]
    }
  ],
  "sprintPlanning": {
    "suggestedOrder": [
      "S25-T01",
      "S25-T02",
      "S25-T03",
      "S25-T04",
      "S25-T05",
      "S25-T06",
      "S25-T07",
      "S25-T08",
      "S25-T11",
      "S25-T09",
      "S25-T10"
    ],
    "timeboxGuidance": {
      "P0_total_days": 5,
      "P1_total_days": 1,
      "buffer_days": 1
    },
    "notes": [
      "Use Stripe webhooks as the source of truth for subscription status updates (don’t trust client redirects).",
      "Implement both client gating (UX) and server gating (security) for exports.",
      "Customer Portal is the fastest way to support cancellations and payment method updates without building custom billing UI."
    ]
  }
}
