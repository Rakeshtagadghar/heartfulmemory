{
  "meta": {
    "project": "Bloodline Storybook (Phase 1)",
    "planType": "SPRINT_TASKS_JSON",
    "sprint": {
      "number": 4,
      "title": "Storybook Core Data Model (Convex DB + AuthZ)",
      "duration": "1 week",
      "goal": "Implement the core Convex database schema and secure access rules for storybooks, chapters, blocks, assets, and collaborators—private by default—ready for the editor in Sprint 5.",
      "definitionOfDone": [
        "Convex schema created for storybooks/chapters/blocks/assets/collaborators (+ templates optional)",
        "Authorization enforced in every query/mutation (owner-first, share-ready)",
        "Core CRUD queries/mutations implemented and typed",
        "Indexes added for common queries (by ownerId, storybookId, orderIndex)",
        "Seed templates available (code-based or in Convex table)",
        "Integration tests / manual scripts validate no cross-user access",
        "UI wiring: create storybook from onboarding/start page works end-to-end"
      ]
    },
    "stackAssumptions": {
      "db": "Convex",
      "auth": "Auth.js (NextAuth) + Convex OR Convex Auth (as implemented in Migration Sprint 3.5)",
      "app": "Next.js App Router + TypeScript",
      "securityModel": "Server-side authorization checks in Convex functions (no SQL RLS)"
    }
  },
  "dataModel": {
    "enums": {
      "bookMode": ["DIGITAL", "PRINT"],
      "bookStatus": ["DRAFT", "ACTIVE", "ARCHIVED", "DELETED"],
      "chapterStatus": ["DRAFT", "FINAL"],
      "collabRole": ["OWNER", "EDITOR", "VIEWER"],
      "assetSource": [
        "UPLOAD",
        "UNSPLASH",
        "PEXELS",
        "PIXABAY",
        "OPENVERSE",
        "RAWPIXEL_PD",
        "VECTEEZY"
      ],
      "blockType": ["TEXT", "IMAGE", "VIDEO", "GIF", "EMBED"]
    },
    "collections": [
      "users",
      "storybooks",
      "chapters",
      "chapterBlocks",
      "assets",
      "collaborators",
      "templates (optional)",
      "activityLog (optional)"
    ],
    "designPrinciples": [
      "Private by default: all reads/writes must check identity + ownership/permission",
      "Draft-first: content stored flexibly (block content as JSON-ish object)",
      "Order preserved: orderIndex on chapters and blocks",
      "Share-ready: collaborator table exists even if sharing UX comes later",
      "Provider-ready: assets include license metadata (future stock integration)"
    ]
  },
  "backlog": [
    {
      "id": "S4C-T01",
      "title": "Define Convex schema for core collections (storybooks/chapters/blocks/assets/collaborators)",
      "skill": ["Convex Schema", "Data Modeling", "TypeScript"],
      "priority": "P0",
      "requirements": {
        "schema": {
          "storybooks": {
            "fields": [
              "ownerId (string auth subject or users._id reference)",
              "title (string)",
              "subtitle (optional string)",
              "bookMode ('DIGITAL'|'PRINT')",
              "status ('DRAFT'|'ACTIVE'|'ARCHIVED'|'DELETED')",
              "coverAssetId (optional assets._id)",
              "settings (object)",
              "createdAt (number ms)",
              "updatedAt (number ms)"
            ],
            "indexes": ["by_ownerId", "by_ownerId_updatedAt"]
          },
          "chapters": {
            "fields": [
              "storybookId (storybooks._id)",
              "ownerId",
              "title",
              "status ('DRAFT'|'FINAL')",
              "orderIndex (number)",
              "summary (optional string)",
              "createdAt",
              "updatedAt"
            ],
            "indexes": ["by_storybookId_orderIndex", "by_ownerId"]
          },
          "chapterBlocks": {
            "fields": [
              "storybookId",
              "chapterId",
              "ownerId",
              "type ('TEXT'|'IMAGE'|'VIDEO'|'GIF'|'EMBED')",
              "orderIndex (number)",
              "content (object - flexible)",
              "createdAt",
              "updatedAt"
            ],
            "indexes": [
              "by_chapterId_orderIndex",
              "by_storybookId",
              "by_ownerId"
            ]
          },
          "assets": {
            "fields": [
              "ownerId",
              "source ('UPLOAD'|...)",
              "sourceAssetId (optional string)",
              "sourceUrl (optional string)",
              "storageProvider (optional string e.g., 'R2')",
              "storageBucket (optional string)",
              "storageKey (optional string)",
              "mimeType (optional string)",
              "width (optional number)",
              "height (optional number)",
              "durationSeconds (optional number)",
              "sizeBytes (optional number)",
              "checksum (optional string)",
              "license (optional object)",
              "createdAt",
              "updatedAt"
            ],
            "indexes": ["by_ownerId", "by_storageKey"]
          },
          "collaborators": {
            "fields": [
              "storybookId",
              "invitedEmail (optional string)",
              "userId (optional users._id or auth subject)",
              "role ('OWNER'|'EDITOR'|'VIEWER')",
              "status ('PENDING'|'ACCEPTED'|'REVOKED')",
              "createdAt",
              "updatedAt"
            ],
            "indexes": ["by_storybookId", "by_userId", "by_invitedEmail"]
          }
        },
        "constraints": [
          "Choose and standardize identity field: prefer `ownerId` as auth subject string for simplicity",
          "Use Convex validators (v.string(), v.optional(), v.literal(), v.union(), v.object())",
          "Keep `content` as v.any() or structured object (v.object + partial) for flexibility in Sprint 5"
        ],
        "outputs": [
          "convex/schema.ts updated",
          "docs/convex_schema_storybooks.md"
        ]
      },
      "acceptanceTests": [
        "Convex schema deploys without errors",
        "All required indexes exist for primary queries (by_ownerId, by_storybookId_orderIndex, by_chapterId_orderIndex)",
        "TypeScript types generated/usable by Convex client"
      ],
      "deliverables": ["convex/schema.ts", "docs/convex_schema_storybooks.md"]
    },
    {
      "id": "S4C-T02",
      "title": "Implement AuthZ helpers and permission model (owner-first, collaborator-ready)",
      "skill": ["Security", "Convex", "Architecture"],
      "priority": "P0",
      "requirements": {
        "helpers": [
          "requireUser(ctx) -> { subject, userDoc? }",
          "requireOwner(ctx, ownerId) throws if mismatch",
          "canAccessStorybook(ctx, storybookId, minRole) -> boolean",
          "assertCanAccessStorybook(ctx, storybookId, minRole) throws"
        ],
        "roles": {
          "hierarchy": ["OWNER > EDITOR > VIEWER"],
          "defaultBehavior": "Only OWNER can write in Sprint 4; collaborator writes can be added later without schema changes."
        },
        "constraints": [
          "Every query/mutation must call AuthZ helpers (no direct db access without checks)",
          "Fail closed: deny by default"
        ]
      },
      "acceptanceTests": [
        "Unauthenticated calls are rejected consistently",
        "Non-owner cannot read another user's storybook",
        "Owner can read/write their own data"
      ],
      "deliverables": [
        "convex/authz.ts",
        "docs/convex_access_control_storybooks.md"
      ]
    },
    {
      "id": "S4C-T03",
      "title": "Core storybook CRUD (queries + mutations) with typed inputs",
      "skill": ["Convex Functions", "TypeScript"],
      "priority": "P0",
      "requirements": {
        "functions": [
          "mutation storybooks.create({ title?, bookMode?, templateId? }) -> storybookId",
          "query storybooks.listMine() -> storybooks[]",
          "query storybooks.get({ storybookId }) -> storybook",
          "mutation storybooks.update({ storybookId, patch })",
          "mutation storybooks.archive({ storybookId })",
          "mutation storybooks.remove({ storybookId }) (hard delete optional)"
        ],
        "constraints": [
          "All functions enforce AuthZ",
          "Update must also touch updatedAt",
          "Remove must cascade delete chapters/blocks (Convex-side cascade in mutation)"
        ]
      },
      "acceptanceTests": [
        "Create produces a storybook owned by current user",
        "List returns only current user's storybooks",
        "Get denies access if not owner",
        "Delete removes dependent chapters/blocks (if hard delete enabled)"
      ],
      "deliverables": ["convex/storybooks.ts"]
    },
    {
      "id": "S4C-T04",
      "title": "Chapter CRUD + ordering (drag reorder ready)",
      "skill": ["Convex Functions", "Data Modeling"],
      "priority": "P0",
      "requirements": {
        "functions": [
          "mutation chapters.create({ storybookId, title? }) -> chapterId",
          "query chapters.listByStorybook({ storybookId }) -> chapters[] ordered by orderIndex",
          "mutation chapters.rename({ chapterId, title })",
          "mutation chapters.remove({ chapterId })",
          "mutation chapters.reorder({ storybookId, orderedChapterIds[] })"
        ],
        "ordering": [
          "orderIndex recalculated in reorder mutation (0..n-1)",
          "Stable ordering after insert/delete"
        ],
        "constraints": [
          "AuthZ enforced via storybook access",
          "Reorder should be reasonably efficient (batch patches)"
        ]
      },
      "acceptanceTests": [
        "Creating chapter appends to end (max orderIndex + 1)",
        "Reorder persists and returns correct ordering",
        "Non-owner cannot list or mutate chapters"
      ],
      "deliverables": ["convex/chapters.ts"]
    },
    {
      "id": "S4C-T05",
      "title": "Chapter blocks CRUD (v0) compatible with Editor sprint",
      "skill": ["Convex Functions", "TypeScript"],
      "priority": "P0",
      "requirements": {
        "functions": [
          "query blocks.listByChapter({ chapterId }) -> blocks[] ordered by orderIndex",
          "mutation blocks.insert({ chapterId, type, content?, orderIndex? }) -> blockId",
          "mutation blocks.update({ blockId, patch })",
          "mutation blocks.remove({ blockId })",
          "mutation blocks.reorder({ chapterId, orderedBlockIds[] })"
        ],
        "content": [
          "Store TEXT as TipTap/Slate JSON in content",
          "IMAGE can store placeholder content (caption, intended placement) until uploads arrive"
        ],
        "constraints": [
          "AuthZ enforced using chapter->storybook->owner check",
          "updatedAt maintained"
        ]
      },
      "acceptanceTests": [
        "Blocks persist and list in correct order",
        "Update works for large JSON payloads (editor docs) within reasonable limits",
        "Unauthorized access denied"
      ],
      "deliverables": ["convex/blocks.ts"]
    },
    {
      "id": "S4C-T06",
      "title": "Assets collection v0 + linkage strategy (upload later via R2)",
      "skill": ["Data Modeling", "Convex", "Architecture"],
      "priority": "P1",
      "requirements": {
        "functions": [
          "mutation assets.createMetadata({ source, mimeType?, width?, height?, license?, storageKey? }) -> assetId",
          "query assets.listMine({ limit? })",
          "query assets.get({ assetId })"
        ],
        "linkage": [
          "Blocks refer to assets via assetId in content.assetId",
          "Storybook cover references coverAssetId"
        ],
        "constraints": [
          "No direct file storage in Convex for now (R2 in Sprint 7/8)",
          "License metadata fields included (for future stock providers)"
        ]
      },
      "acceptanceTests": [
        "Asset metadata can be created and retrieved by owner",
        "Non-owner cannot read asset metadata",
        "Block can reference an assetId without breaking reads"
      ],
      "deliverables": ["convex/assets.ts", "docs/assets_linking_v0.md"]
    },
    {
      "id": "S4C-T07",
      "title": "Templates v1 storage decision + seed two templates",
      "skill": ["Product", "Convex", "Frontend"],
      "priority": "P1",
      "requirements": {
        "chooseOne": [
          "Store templates in code (content/templates/*.ts) and apply via Convex mutation that writes chapters/blocks",
          "Store templates in Convex `templates` collection for dynamic editing later"
        ],
        "minimumTemplates": [
          {
            "templateId": "childhood_roots",
            "name": "Childhood & Roots",
            "chapters": [
              "Origins",
              "Childhood Home",
              "School Days",
              "Family Traditions"
            ]
          },
          {
            "templateId": "love_family",
            "name": "Love & Family",
            "chapters": [
              "How We Met",
              "Wedding",
              "First Home",
              "Lessons of Love"
            ]
          }
        ],
        "applyFlow": [
          "mutation templates.apply({ templateId }) -> storybookId",
          "creates storybook + chapters + one starter TEXT block per chapter"
        ],
        "constraints": [
          "Templates must be versioned (templateVersion)",
          "Applying templates copies into user-owned docs"
        ]
      },
      "acceptanceTests": [
        "Applying template creates correct chapters and blocks in order",
        "Template content never changes existing created books"
      ],
      "deliverables": [
        "convex/templates.ts (optional)",
        "content/templates/*",
        "docs/templates_v1_convex.md"
      ]
    },
    {
      "id": "S4C-T08",
      "title": "Next.js wiring: replace old data layer with Convex hooks for storybook start flow",
      "skill": ["Frontend (Next.js)", "Convex Client"],
      "priority": "P0",
      "requirements": {
        "uiFlow": [
          "/app/start: choose blank or template",
          "Create storybook (Convex mutation) then route to /app/storybooks/:id",
          "/app/storybooks/:id: show chapters list (read via Convex query)"
        ],
        "constraints": [
          "No editor yet—just verify persistence and navigation",
          "Handle loading + error states"
        ]
      },
      "acceptanceTests": [
        "User can create a storybook and see it on dashboard after refresh",
        "Chapters list loads from Convex and is ordered",
        "Unauthorized users cannot access /app/*"
      ],
      "deliverables": [
        "app/app/start/page.tsx updated",
        "app/app/storybooks/[id]/page.tsx updated",
        "components/storybooks/* updated to use Convex"
      ]
    },
    {
      "id": "S4C-T09",
      "title": "Security tests: cross-user access denial + basic smoke scripts",
      "skill": ["Testing", "Security"],
      "priority": "P0",
      "requirements": {
        "tests": [
          "User A creates storybook",
          "User B cannot read/list/get A's storybook",
          "Anon cannot call protected queries/mutations",
          "Owner can create/list/update/delete"
        ],
        "approach": [
          "Convex function tests or manual scripted checks documented",
          "At minimum: a repeatable manual checklist"
        ],
        "constraints": ["Fail closed: if unsure, deny access"]
      },
      "acceptanceTests": [
        "Security checklist passes",
        "No accidental public queries exist",
        "All functions use authz helpers"
      ],
      "deliverables": [
        "docs/security_checklist_convex_s4.md",
        "docs/authz_smoke_steps.md"
      ]
    },
    {
      "id": "S4C-T10",
      "title": "Release Sprint 4: deploy Convex schema + functions, verify in production",
      "skill": ["Release", "DevOps-lite", "Convex"],
      "priority": "P0",
      "requirements": {
        "releaseChecklist": [
          "Deploy Convex schema & functions",
          "Verify auth identity works in Convex functions",
          "Create storybook (blank + template) in production",
          "Verify chapters created and ordered",
          "Verify unauthorized access denied (manual test from another account)"
        ]
      },
      "acceptanceTests": [
        "Production app supports create/list/open storybooks",
        "No cross-user data leakage",
        "Checklist recorded"
      ],
      "deliverables": ["docs/release_checklist_s4_convex.md"]
    }
  ],
  "sprintPlanning": {
    "suggestedOrder": [
      "S4C-T01",
      "S4C-T02",
      "S4C-T03",
      "S4C-T04",
      "S4C-T05",
      "S4C-T08",
      "S4C-T06",
      "S4C-T07",
      "S4C-T09",
      "S4C-T10"
    ],
    "timeboxGuidance": {
      "P0_total_days": 5,
      "P1_total_days": 1.5,
      "buffer_days": 0.5
    },
    "notes": [
      "This sprint replaces 'Supabase Postgres + RLS' with 'Convex DB + server-side AuthZ'.",
      "Keep collaborators enforced as read-only (viewer) or owner-only in Sprint 4; you can expand roles in the Sharing sprint without breaking schema.",
      "Block content remains flexible to support Editor v0 in Sprint 5; strict media rules arrive later."
    ]
  }
}
